<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Saanvi Khopkar Swim Cuts</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f4f9fc;
      padding-top: 80px;
      color: #2c3e50;
    }
    #header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background-color: #fff;
      padding: 1rem;
      text-align: center;
      font-size: 2rem;
      color: #2c3e50;
      z-index: 1000;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .summary {
      text-align: center;
      margin: 2rem auto 0.5rem;
      font-weight: bold;
    }
    .summary h2 {
      font-size: 1.5rem;
      margin-bottom: 0.3rem;
      background-color: #d0eaff;
      padding: 0.3rem;
      border-radius: 5px;
    }
    .summary p {
      margin: 0.2rem 0;
    }
    .divider {
      border-top: 3px solid #ccc;
      width: 90%;
      margin: 3rem auto;
    }
    table {
      width: 90%;
      margin: 1rem auto;
      border-collapse: collapse;
    }
    th, td {
      border: 2px solid #888;
      padding: 0.5rem;
      text-align: center;
    }
    th {
      background-color: #e9f5fb;
      font-weight: bold;
    }
    .scy-met, .lcm-met {
      background-color: #d0f0c0; /* pleasant green */
    }
    .scy-miss, .lcm-miss {
      background-color: #fbdcdc; /* pleasant red */
    }
    .achieved {
      color: green;
      font-weight: bold;
    }
    .missed {
      color: #c0392b;
      font-weight: bold;
    }
    @media (max-width: 768px) {
      table, thead, tbody, th, td, tr {
        font-size: 0.85rem;
      }
    }
  </style>
</head>
<body>
  <div id="header">Saanvi Khopkar, Age <span id="age"></span></div>

  <div id="content">
    <!-- Tables are inserted here dynamically -->
  </div>

  <script>
    const swimmerDOB = new Date("2010-01-02");
    const today = new Date();
    let age = today.getFullYear() - swimmerDOB.getFullYear();
    const m = today.getMonth() - swimmerDOB.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < swimmerDOB.getDate())) age--;
    document.getElementById("age").innerText = age;

    const eventOrder = [
      "50 Freestyle", "100 Freestyle", "200 Freestyle", "500 Freestyle",
      "100 Butterfly", "200 Butterfly", "100 Breastroke", "200 Breastroke",
      "100 Backstroke", "200 Backstroke", "200 IM"
    ];

    const formatTime = timeStr => {
      if (!timeStr) return null;
      const parts = timeStr.split(":").map(Number);
      return parts.length === 1
        ? parts[0]
        : parts[0] * 60 + parts[1];
    };

    const fetchCSV = async url => {
      const res = await fetch(url);
      const text = await res.text();
      const [headers, ...rows] = text.trim().split("\n").map(r => r.split(","));
      return rows.map(row =>
        Object.fromEntries(row.map((v, i) => [headers[i].trim(), v.trim()]))
      );
    };

    const loadData = async () => {
      const swimURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR517EAit_Mv_l2LJa7TbXINy5Eq-v9fa9kwF8QX0ZUk8GG2pRbtBjPzM4vN8X00w/pub?gid=1331787204&single=true&output=csv";
      const stdURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS8azb2ync4URwqJmg9XiYUqVH9IMsHkbVYSf71e8lwIgrqOlB9ezp4HHYhDbG_gw/pub?gid=1081039398&single=true&output=csv";

      const swimData = await fetchCSV(swimURL);
      const stdData = await fetchCSV(stdURL);

      const pbTimes = {};
      swimData.forEach(entry => {
        const { course, event, final_time } = entry;
        const key = `${course}_${event}`;
        const ft = formatTime(final_time);
        if (!ft) return;
        if (!pbTimes[key] || ft < pbTimes[key].time) {
          pbTimes[key] = { time: ft, raw: final_time };
        }
      });

      const buildTable = (label, stds) => {
        const scy = [], lcm = [];
        const getEntry = (event, course) => {
          const stdTime = formatTime(stds[`${course}_${event}`]);
          const swimmer = pbTimes[`${course}_${event}`];
          if (!stdTime || !swimmer) return null;
          const diff = swimmer.time - stdTime;
          return {
            event,
            std: stdTime,
            swimmer: swimmer.raw,
            diff,
            class: diff <= 0 ? `${course.toLowerCase()}-met` : `${course.toLowerCase()}-miss`,
            status: diff <= 0 ? 'Achieved' : `${diff.toFixed(2)}s away`,
            statusClass: diff <= 0 ? 'achieved' : 'missed'
          };
        };

        eventOrder.forEach(event => {
          const s = getEntry(event, "SCY");
          const l = getEntry(event, "LCM");
          if (s || l) {
            const row = {
              event,
              scy: s,
              lcm: l
            };
            scy.push(row);
          }
        });

        const countCuts = (rows, course) =>
          rows.filter(r => r[course]?.status === "Achieved").length;

        const section = document.createElement("div");
        section.innerHTML = `
          <div class="summary">
            <h2>${label}</h2>
            <p>SCY: ${countCuts(scy, "scy")} cuts &nbsp;&nbsp; LCM: ${countCuts(scy, "lcm")} cuts</p>
          </div>
          <table>
            <thead>
              <tr>
                <th>SCY Standards</th>
                <th>SCY PB</th>
                <th>Event</th>
                <th>LCM PB</th>
                <th>LCM Standards</th>
              </tr>
            </thead>
            <tbody>
              ${scy.map(row => `
                <tr>
                  <td><b>${stds[`SCY_${row.event}`] || ""}</b></td>
                  <td class="${row.scy?.class || ""}">${row.scy?.swimmer || ""}<br><span class="${row.scy?.statusClass || ""}">${row.scy?.status || ""}</span></td>
                  <td><b>${row.event}</b></td>
                  <td class="${row.lcm?.class || ""}">${row.lcm?.swimmer || ""}<br><span class="${row.lcm?.statusClass || ""}">${row.lcm?.status || ""}</span></td>
                  <td><b>${stds[`LCM_${row.event}`] || ""}</b></td>
                </tr>`).join("")}
            </tbody>
          </table>
        `;
        return section;
      };

      const standards = { Regionals: {}, State: {} };
      stdData.forEach(entry => {
        const key = `${entry.Course}_${entry.Event}`;
        standards[entry.Standards][key] = entry.Time;
      });

      const container = document.getElementById("content");
      container.appendChild(buildTable("Regionals", standards.Regionals));
      container.appendChild(document.createElement("div")).classList.add("divider");
      container.appendChild(buildTable("State", standards.State));
    };

    loadData();
  </script>
</body>
</html>
